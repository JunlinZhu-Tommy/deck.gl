requirejs.config({
  enforceDefine: true,
  paths: {
    deck: 'https://unpkg.com/@deck.gl/core@7.1.0/dist/dist.dev',
    deckjson: 'https://unpkg.com/@deck.gl/json@7.1.0/dist/dist.dev',
    decklayers: 'https://unpkg.com/@deck.gl/layers@7.1.0/dist/dist.dev',
    deckaggregate: 'https://unpkg.com/@deck.gl/aggregation-layers@7.1.0/dist/dist.dev',
    mapboxjs: 'https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl',
    luma: 'https://unpkg.com/@luma.gl/core@7.1.0/dist/dist.min'
  }
});

function onViewportChange({viewport}) {
  config.setProps({viewState: viewport});
}


requirejs(['luma', 'deckjson', 'deck', 'decklayers', 'mapboxjs'], function(
  luma, deckJson, deckgl, deckglLayers, mbjs) {

  const deckAggregationLayers = require(['deckaggregate']);

  const jsonConverter = new deckJson._JSONConverter({
    configuration: {
      layers: {...deckglLayers, ...deckAggregationLayers}
    }
  });

  const config = new deckgl.Deck({
    canvas: 'deck-map-container',
    height: '100%',
    width: '100%',
    mapboxApiAccessToken: '{{mapbox_api_key}}',
    views: [new deckgl.MapView()],
    onViewStateChange: onViewportChange.bind(this)
  });

  const jsonProps = jsonConverter.convertJsonToDeckProps({{json_input}});
  config.setProps(jsonProps);

});
